{% extends "base.html" %}

{% block title %}Gallery - AI Reel Generator{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h2>üóëÔ∏è Delete Reel?</h2>
        <p>Are you sure you want to delete this reel? This action cannot be undone and the file will be permanently
            removed.</p>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmDelete()">Delete Forever</button>
        </div>
    </div>
</div>

<div class="container gallery-container">
    <h1 class="gallery-title">Reel Gallery</h1>

    {% if reels %}
    <div class="gallery-stats">
        <h3>üìä Total Reels: {{ reels|length }}</h3>
    </div>

    <div class="gallery-grid">
        {% for reel in reels %}
        <div class="gallery-item" id="reel-{{ loop.index }}">
            <div class="reel-card">
                <video controls preload="metadata">
                    <source src="{{ url_for('static', filename='reels/' ~ reel.filename) }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="reel-info">
                    <p>{{ reel.name }}</p>
                    <span class="file-size-badge">{{ "%.2f"|format(reel.size / (1024*1024)) }} MB</span>
                </div>

                {% if reel.image_count or reel.duration or reel.aspect_ratio %}
                <div class="reel-metadata">
                    {% if reel.image_count %}
                    <div class="metadata-item">
                        <span class="metadata-label">üì∏ Images:</span>
                        <span>{{ reel.image_count }}</span>
                    </div>
                    {% endif %}
                    {% if reel.duration %}
                    <div class="metadata-item">
                        <span class="metadata-label">‚è±Ô∏è Duration/Image:</span>
                        <span>{{ reel.duration }}s</span>
                    </div>
                    {% endif %}
                    {% if reel.aspect_ratio %}
                    <div class="metadata-item">
                        <span class="metadata-label">üìê Aspect Ratio:</span>
                        <span>{{ reel.aspect_ratio }}</span>
                    </div>
                    {% endif %}
                    {% if reel.transition %}
                    <div class="metadata-item">
                        <span class="metadata-label">‚ú® Transition:</span>
                        <span>{{ reel.transition|capitalize }}</span>
                    </div>
                    {% endif %}
                    <div class="metadata-item">
                        <span class="metadata-label">üìÖ Created:</span>
                        <span>{{ reel.created_at }}</span>
                    </div>
                </div>
                {% endif %}

                <div class="reel-actions">
                    <a href="{{ url_for('static', filename='reels/' ~ reel.filename) }}" download="{{ reel.filename }}"
                        class="action-btn download-btn">
                        üì• Download
                    </a>
                    <button class="action-btn delete-btn"
                        onclick="showDeleteModal('{{ reel.filename }}', 'reel-{{ loop.index }}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-reels">
        <p>üì≠ No reels created yet.</p>
        <a href="/create">‚ú® Create Your First Reel</a>
    </div>
    {% endif %}
</div>

<script>
    let reelToDelete = null;
    let reelElementId = null;

    function showDeleteModal(reelName, elementId) {
        reelToDelete = reelName;
        reelElementId = elementId;
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        reelToDelete = null;
        reelElementId = null;
    }

    async function confirmDelete() {
        if (!reelToDelete) return;

        try {
            const response = await fetch(`/delete/${reelToDelete}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                const reelElement = document.getElementById(reelElementId);
                if (reelElement) {
                    reelElement.style.opacity = '0';
                    reelElement.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        reelElement.remove();

                        const galleryGrid = document.querySelector('.gallery-grid');
                        if (galleryGrid && galleryGrid.children.length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
                closeDeleteModal();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error deleting reel: ' + error.message);
        }
    }

    document.getElementById('deleteModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}